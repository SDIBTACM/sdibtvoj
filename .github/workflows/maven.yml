name: Java CI with Diagnostics

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Diagnostic - Dependency Tree
      run: mvn dependency:tree -Dverbose > dependency-tree.log
      
    - name: Upload Dependency Tree
      uses: actions/upload-artifact@v4
      with:
        name: dependency-tree
        path: dependency-tree.log

    - name: Build with Minify Workaround
      run: |
        # 尝试修复依赖
        mvn dependency:get -Dartifact=org.codehaus.plexus:plexus-utils:3.4.2
        mvn dependency:get -Dartifact=com.google.guava:guava:32.1.2-jre
        
        # 构建项目（带跳过选项）
        mvn -B clean package -DskipMinify

    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: target-artifacts
        path: target/*.jar
